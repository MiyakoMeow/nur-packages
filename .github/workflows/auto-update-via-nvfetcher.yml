name: Auto Update Packages via Nvfetcher
on:
  schedule:
    - cron: "0 12 * * *" # æ¯å¤© UTC ä¸­åˆ12ç‚¹è¿è¡Œ
  push:
    paths:
      - "nvfetcher.toml" # åœ¨åŒ…å®šä¹‰æ–‡ä»¶æœ‰æ›´æ”¹æ—¶è§¦å‘
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update:
    strategy:
      matrix:
        nixPath:
          - nixpkgs=https://github.com/NixOS/nixpkgs/archive/refs/heads/nixos-25.05.tar.gz
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.update.outputs.has_updates }}
      pr_number: ${{ steps.create-pull-request.outputs.pull-request-number }}
      pr_operation: ${{ steps.create-pull-request.outputs.pull-request-operation }}
      timestamp: ${{ steps.timestamp.outputs.timestamp }}
    steps:
      - name: ğŸ›ï¸ æ£€å‡ºä»“åº“
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.AUTOMERGE_TOKEN }}

      - name: âš™ï¸ è®¾ç½® Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: "${{ matrix.nixPath }}"
          extra_nix_config: |
            experimental-features = nix-command flakes
            access-tokens = github.com=${{ secrets.AUTOMERGE_TOKEN }}
            extra-platforms = aarch64-linux

      - name: Show nixpkgs version
        run: nix-instantiate --eval -E '(import <nixpkgs> {}).lib.version'

      - name: Install nvfetcher
        run: nix profile add nixpkgs#git github:berberman/nvfetcher

      # ç”Ÿæˆå”¯ä¸€æ—¶é—´æˆ³ä½œä¸ºåˆ†æ”¯ååç¼€
      - name: â° ç”Ÿæˆæ—¶é—´æˆ³
        id: timestamp
        run: echo "timestamp=$(date +%s)" >> $GITHUB_OUTPUT

      - name: ğŸ”„ è¿è¡Œæ›´æ–°
        id: update
        run: |
          #!/usr/bin/env bash
          set -euo pipefail

          # è¿è¡Œnvfetcher
          nvfetcher -c ./nvfetcher.toml --keep-going

          git config user.name "MiyakoMeow Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
          if [[ -n $(git status --porcelain ./_sources) ]]; then
              echo "âœ… æ£€æµ‹åˆ°æ›´æ–°!"
              git add ./_sources
              git commit -m "chore: auto-update via nvfetcher"
              echo "has_updates=true" >> $GITHUB_OUTPUT
          else
              echo "â„¹ï¸ æ— å¯ç”¨æ›´æ–°"
              echo "has_updates=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.AUTOMERGE_TOKEN }}

      # åŠ¨æ€ç”Ÿæˆ PR æ­£æ–‡
      - name: ğŸ“ ç”Ÿæˆ PR æ­£æ–‡
        if: steps.update.outputs.has_updates == 'true'
        id: pr-body
        run: |
          # è·å–æœ€æ–°æäº¤ä¿¡æ¯
          COMMIT_MSG=$(git log -1 --pretty=%B)

          # åˆ›å»º PR æ­£æ–‡æ–‡ä»¶
          echo "âš¡ ç”± nvfetcher è‡ªåŠ¨ç”Ÿæˆçš„åŒ…æ›´æ–°" > pr_body.md
          echo "**åŒ…å«ä»¥ä¸‹æ›´æ–°:**" >> pr_body.md
          echo "\`\`\`" >> pr_body.md
          echo "$COMMIT_MSG" >> pr_body.md
          echo "\`\`\`" >> pr_body.md

          # æ·»åŠ æ–‡ä»¶å˜æ›´åˆ—è¡¨
          echo "**æ›´æ–°çš„æ–‡ä»¶:**" >> pr_body.md
          git diff --name-only HEAD^ HEAD -- _sources | sed 's/^/- `/' | sed 's/$/`/' >> pr_body.md

          # è¾“å‡ºæ–‡ä»¶å†…å®¹ä¾›éªŒè¯
          cat pr_body.md

          # ä¿å­˜ä¸ºè¾“å‡º
          BODY_CONTENT=$(cat pr_body.md)
          echo "body_content<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ“¦ åˆ›å»º PR
        if: steps.update.outputs.has_updates == 'true'
        id: create-pull-request
        uses: peter-evans/create-pull-request@v7
        with:
          title: "Auto Update(nvfetcher)"
          branch: "auto-update-${{ steps.timestamp.outputs.timestamp }}"
          delete-branch: true
          body: ${{ steps.pr-body.outputs.body_content }}
          labels: "automated, dependencies"
          token: ${{ secrets.AUTOMERGE_TOKEN }}
          # Act like github-actions
          commit-message: "chore: auto-update packages"
          committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          author: ${{ github.actor }} <${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com>

  build:
    needs: update
    if: needs.update.outputs.has_updates == 'true' && needs.update.outputs.pr_operation == 'created'
    strategy:
      matrix:
        # Set this to notify the global nur package registry that changes are
        # available.
        #
        # The repo name as used in
        # https://github.com/nix-community/NUR/blob/master/repos.json
        nurRepo:
          - MiyakoMeow/nur-packages
        # Set this to cache your build results in cachix for faster builds
        # in CI and for everyone who uses your cache.
        #
        # Format: Your cachix cache host name without the ".cachix.org" suffix.
        # Example: mycache (for mycache.cachix.org)
        #
        # For this to work, you also need to set the CACHIX_SIGNING_KEY or
        # CACHIX_AUTH_TOKEN secret in your repository secrets settings in
        # Github found at
        # https://github.com/<your_githubname>/nur-packages/settings/secrets
        cachixName:
          - miyakomeow
        nixPath:
          - nixpkgs=https://github.com/NixOS/nixpkgs/archive/refs/heads/nixos-25.05.tar.gz
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: auto-update-${{ needs.update.outputs.timestamp }}

      - name: Install nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: "${{ matrix.nixPath }}"
          extra_nix_config: |
            experimental-features = nix-command flakes
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
            extra-platforms = aarch64-linux

      - name: Show nixpkgs version
        run: nix-instantiate --eval -E '(import <nixpkgs> {}).lib.version'

      - name: Setup cachix
        uses: cachix/cachix-action@v16
        # Don't replace <YOUR_CACHIX_NAME> here!
        if: ${{ matrix.cachixName != '<YOUR_CACHIX_NAME>' }}
        with:
          name: ${{ matrix.cachixName }}
          signingKey: "${{ secrets.CACHIX_SIGNING_KEY }}"
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"

      - name: Check evaluation
        run: |
          nix-env -f . -qa \* --meta --xml \
            --option allow-import-from-derivation true \
            --drv-path --show-trace \
            -I nixpkgs=$(nix-instantiate --find-file nixpkgs) \
            -I $PWD

      - name: Build nix packages
        run: nix shell -f '<nixpkgs>' nix-build-uncached -c nix-build-uncached ci.nix -A cacheOutputs

  merge:
    needs: [update, build]
    if: needs.update.outputs.has_updates == 'true' && needs.update.outputs.pr_operation == 'created' && success()
    runs-on: ubuntu-latest
    steps:
      - name: Enable Pull Request Automerge
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.AUTOMERGE_TOKEN }}
          pull-request-number: ${{ needs.update.outputs.pr_number }}
          merge-method: merge

      - name: Delete source branch after merge
        if: success()
        run: |
          # ç­‰å¾…ä¸€æ®µæ—¶é—´è®©PRåˆå¹¶å®Œæˆ
          sleep 10

          # æ£€æŸ¥PRæ˜¯å¦å·²åˆå¹¶
          PR_STATUS=$(gh api "repos/${{ github.repository }}/pulls/${{ needs.update.outputs.pr_number }}" --jq '.merged')

          if [ "$PR_STATUS" = "true" ]; then
            echo "PRå·²åˆå¹¶ï¼Œå¼€å§‹åˆ é™¤æºåˆ†æ”¯"
            BRANCH_NAME="auto-update-${{ needs.update.outputs.timestamp }}"

            # åˆ é™¤åˆ†æ”¯
            gh api \
              --method DELETE \
              "repos/${{ github.repository }}/git/refs/heads/$BRANCH_NAME" \
              -H "Accept: application/vnd.github.v3+json" \
              || echo "åˆ†æ”¯ $BRANCH_NAME åˆ é™¤å¤±è´¥æˆ–å·²ä¸å­˜åœ¨"

            echo "âœ… åˆ†æ”¯ $BRANCH_NAME åˆ é™¤å®Œæˆ"
          else
            echo "PRå°šæœªåˆå¹¶ï¼Œè·³è¿‡åˆ†æ”¯åˆ é™¤"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.AUTOMERGE_TOKEN }}
