name: Auto Update Packages
on:
  schedule:
    - cron: "0 12 * * *" # æ¯å¤© UTC ä¸­åˆ12ç‚¹è¿è¡Œ
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update:
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.update.outputs.has_updates }}
    steps:
      - name: ğŸ›ï¸ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âš™ï¸ è®¾ç½® Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”„ è¿è¡Œæ›´æ–°
        id: update
        run: |
          chmod +x ./scripts/nvfetcher-update.sh
          ./scripts/nvfetcher-update.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ åˆ›å»º PR
        if: steps.update.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          title: "chore: auto-update packages via nvfetcher"
          branch: "auto-update-$(date +%s)"
          commit-message: "chore: auto-update packages"
          body: |
            âš¡ ç”± nvfetcher è‡ªåŠ¨ç”Ÿæˆçš„åŒ…æ›´æ–°
            **åŒ…å«ä»¥ä¸‹æ›´æ–°:**
            $(git log -1 --pretty=%B)
          labels: "automated, dependencies"
          token: ${{ secrets.GITHUB_TOKEN }}
