name: Auto Update Packages
on:
  schedule:
    - cron: "0 12 * * *" # 每天 UTC 中午12点运行
  workflow_dispatch: # 允许手动触发

jobs:
  update:
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.update.outputs.has_updates }}
    steps:
      - name: 🛎️ 检出仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ⚙️ 设置 Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

      - name: 🔄 运行更新
        id: update
        run: |
          #!/usr/bin/env bash
          set -euo pipefail

          # 安装 nvfetcher (来自 nixpkgs)
          echo "🔧 安装 nvfetcher..."
          nix-env --install nvfetcher

          # 更新源文件
          echo "🔄 运行 nvfetcher..."
          nvfetcher -c ./nvfetcher.toml --build-dir ./pkgs/_sources

          # 检查是否有更新
          if [[ -n $(git status --porcelain ./pkgs/_sources) ]]; then
              echo "✅ 检测到更新!"
              git add ./pkgs/_sources
              git commit -m "chore: auto-update via nvfetcher"
              echo "::set-output name=has_updates::true" # 设置输出变量
              exit 0
          else
              echo "ℹ️ 无可用更新"
              echo "::set-output name=has_updates::false" # 设置输出变量
              exit 0                                      # 正常退出避免工作流失败
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 📦 创建 PR
        if: steps.update.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          title: "chore: auto-update packages via nvfetcher"
          branch: "auto-update-$(date +%s)"
          commit-message: "chore: auto-update packages"
          body: |
            ⚡ 由 nvfetcher 自动生成的包更新
            **包含以下更新:**
            $(git log -1 --pretty=%B)
          labels: "automated, dependencies"
          token: ${{ secrets.GITHUB_TOKEN }}
