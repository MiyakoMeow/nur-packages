name: Auto Update Packages via Nvfetcher
on:
  schedule:
    - cron: "0 12 * * *" # æ¯å¤© UTC ä¸­åˆ12ç‚¹è¿è¡Œ
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update:
    strategy:
      matrix:
        nixPath:
          - nixpkgs=https://github.com/NixOS/nixpkgs/archive/refs/heads/nixpkgs-unstable.tar.gz
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.update.outputs.has_updates }}
    steps:
      - name: ğŸ›ï¸ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âš™ï¸ è®¾ç½® Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: "${{ matrix.nixPath }}"
          extra_nix_config: |
            experimental-features = nix-command flakes
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
            extra-platforms = aarch64-linux

      - name: Show nixpkgs version
        run: nix-instantiate --eval -E '(import <nixpkgs> {}).lib.version'

      - name: ğŸ“¦ å®‰è£… GitHub CLI
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo gpg --dearmor -o /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      - name: ğŸ”‘ é…ç½® GitHub CLI
        run: |
          # è®¾ç½® GitHub CLI è®¤è¯
          gh auth login --with-token <<< "${{ secrets.AUTOMERGE_TOKEN }}"
          # é…ç½®é»˜è®¤ä»“åº“
          gh repo set-default $GITHUB_REPOSITORY

      - name: ğŸ”„ è¿è¡Œæ›´æ–°
        id: update
        run: |
          #!/usr/bin/env bash
          set -euo pipefail

          # è¿è¡Œnvfetcher
          nix run nixpkgs#nvfetcher -- -c ./nvfetcher.toml --keep-going

          git config user.name "MiyakoMeow Bot - Update"
          git config user.email "miyakomeow-bot@github.noreply.com"
          git remote set-url origin "https://x-access-token:$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY.git"

          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
          if [[ -n $(git status --porcelain ./_sources) ]]; then
              echo "âœ… æ£€æµ‹åˆ°æ›´æ–°!"
              git add ./_sources
              git commit -m "chore: auto-update via nvfetcher"
              
              # åˆ›å»ºæ—¶é—´æˆ³åˆ†æ”¯å
              TIMESTAMP=$(date +%s)
              BRANCH_NAME="auto-update-$TIMESTAMP"
              
              # åˆ›å»ºæ–°åˆ†æ”¯å¹¶æ¨é€
              git checkout -b "$BRANCH_NAME"
              git push origin "$BRANCH_NAME"
              
              # åˆ›å»º PR (ä½¿ç”¨ GitHub CLI)
              echo "ğŸ“¦ åˆ›å»º PR: $BRANCH_NAME"
              gh pr create \
                --title "chore: auto-update packages via nvfetcher" \
                --body "âš¡ ç”± nvfetcher è‡ªåŠ¨ç”Ÿæˆçš„åŒ…æ›´æ–°" \
                --base main \
                --head "$BRANCH_NAME" \
                --label "automated,dependencies"

              echo "::set-output name=has_updates::true" # è®¾ç½®è¾“å‡ºå˜é‡
              exit 0
          else
              echo "â„¹ï¸ æ— å¯ç”¨æ›´æ–°"
              echo "::set-output name=has_updates::false" # è®¾ç½®è¾“å‡ºå˜é‡
              exit 0                                      # æ­£å¸¸é€€å‡ºé¿å…å·¥ä½œæµå¤±è´¥
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.AUTOMERGE_TOKEN }}
